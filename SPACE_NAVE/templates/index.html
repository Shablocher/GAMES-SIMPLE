<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <title>Space War: Boss Strike</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; }
        canvas { display: block; }
        
        #ui { position: absolute; top: 20px; left: 20px; color: #0ff; pointer-events: none; }
        
        #boss-ui { 
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 500px; display: none; text-align: center; color: white;
        }
        #boss-bar { width: 100%; height: 20px; background: #200; border: 2px solid #f00; margin-top: 5px; }
        #boss-fill { width: 100%; height: 100%; background: #f00; }

        #victory-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            color: #ffd700; text-align: center; z-index: 100;
        }
        .restart-btn {
            margin-top: 30px; padding: 15px 40px; font-size: 20px;
            background: #ffd700; border: none; cursor: pointer; font-weight: bold;
        }
    </style>
</head>
<body>

<div id="ui">
    <div style="font-size: 28px;">SCORE: <span id="score">0</span></div>
    <div style="margin-top:10px;">ESCUDOS: <span id="hp-text">100</span>%</div>
</div>

<div id="boss-ui">
    <div style="font-weight: bold; color: #ff0044; letter-spacing: 2px;">ALERTA: CRUZADOR INIMIGO DETETADO</div>
    <div id="boss-bar"><div id="boss-fill"></div></div>
</div>

<div id="victory-screen">
    <h1>VITÓRIA ABSOLUTA!</h1>
    <p>A ameaça espacial foi eliminada.</p>
    <div style="font-size: 32px;">SCORE FINAL: <span id="final-score">0</span></div>
    <button class="restart-btn" onclick="location.reload()">NOVA MISSÃO</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSound(type) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);

    if (type === 'laser') {
        osc.frequency.setValueAtTime(800, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    } else if (type === 'boss_laser') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(200, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.3);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.start(); osc.stop(audioCtx.currentTime + 0.3);
    } else if (type === 'explosion') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(100, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.4);
        osc.start(); osc.stop(audioCtx.currentTime + 0.4);
    } else if (type === 'victory') {
        [261, 329, 392, 523].forEach((f, i) => {
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.frequency.setValueAtTime(f, audioCtx.currentTime + i*0.15);
            g.gain.setValueAtTime(0.2, audioCtx.currentTime + i*0.15);
            g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + i*0.15 + 0.4);
            o.start(audioCtx.currentTime + i*0.15); o.stop(audioCtx.currentTime + i*0.15 + 0.4);
        });
    }
}

// ESTADOS
let score = 0;
let gameActive = true;
let bossMode = false;

const player = { x: canvas.width/2, y: canvas.height-80, w: 50, h: 50, hp: 100, reloading: false };
const boss = { x: canvas.width/2 - 125, y: -150, w: 250, h: 100, hp: 600, maxHp: 600, speed: 4, dir: 1 };

let projectiles = [];     // Tiros do jogador
let bossProjectiles = []; // Tiros do Boss
let enemies = [];         // Meteoros/Monstros
let particles = [];
const keys = {};

window.addEventListener('keydown', e => { 
    keys[e.code] = true;
    if(audioCtx.state === 'suspended') audioCtx.resume();
});
window.addEventListener('keyup', e => keys[e.code] = false);

function createExplosion(x, y, color) {
    playSound('explosion');
    for(let i=0; i<20; i++) {
        particles.push({
            x, y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
            life: 1.0, color
        });
    }
}

function checkCollision(a, b) {
    return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
}

function update() {
    if (!gameActive) return;

    // Movimento Player
    if (keys['ArrowLeft'] && player.x > 0) player.x -= 8;
    if (keys['ArrowRight'] && player.x < canvas.width - player.w) player.x += 8;
    if (keys['Space'] && !player.reloading) {
        projectiles.push({ x: player.x + player.w/2 - 3, y: player.y, w: 6, h: 20 });
        playSound('laser');
        player.reloading = true;
        setTimeout(() => player.reloading = false, 200);
    }

    // Lógica Inimigos Comuns
    if (!bossMode) {
        if (Math.random() < 0.03) {
            enemies.push({ x: Math.random()*(canvas.width-40), y: -50, w: 40, h: 40, speed: 4 });
        }
        if (score >= 500) {
            bossMode = true;
            document.getElementById('boss-ui').style.display = 'block';
        }
    }

    // Lógica do Boss
    if (bossMode) {
        if (boss.y < 80) boss.y += 2; // Entrada
        else {
            boss.x += boss.speed * boss.dir;
            if (boss.x <= 0 || boss.x + boss.w >= canvas.width) boss.dir *= -1;

            // DISPARO ALEATÓRIO DO BOSS
            if (Math.random() < 0.04) { // 4% de chance por frame
                bossProjectiles.push({ x: boss.x + boss.w/2 - 5, y: boss.y + boss.h, w: 10, h: 25 });
                playSound('boss_laser');
            }
        }
    }

    // Update Tiros Jogador
    projectiles.forEach((p, pi) => {
        p.y -= 15;
        if (bossMode && checkCollision(p, boss)) {
            boss.hp -= 10;
            projectiles.splice(pi, 1);
            document.getElementById('boss-fill').style.width = (boss.hp/boss.maxHp)*100 + "%";
            if (boss.hp <= 0) {
                createExplosion(boss.x + boss.w/2, boss.y + boss.h/2, '#ff0');
                gameActive = false;
                setTimeout(showVictory, 500);
            }
        }
    });

    // Update Tiros Boss
    bossProjectiles.forEach((bp, bpi) => {
        bp.y += 7;
        if (checkCollision(bp, player)) {
            player.hp -= 20;
            bossProjectiles.splice(bpi, 1);
            updateHP();
        }
        if (bp.y > canvas.height) bossProjectiles.splice(bpi, 1);
    });

    // Inimigos e Colisões
    enemies.forEach((en, ei) => {
        en.y += en.speed;
        if (checkCollision(en, player)) {
            player.hp -= 20;
            enemies.splice(ei, 1);
            updateHP();
        }
        projectiles.forEach((p, pi) => {
            if (checkCollision(p, en)) {
                createExplosion(en.x, en.y, '#f44');
                enemies.splice(ei, 1);
                projectiles.splice(pi, 1);
                score += 50;
                document.getElementById('score').innerText = score;
            }
        });
    });

    particles.forEach((pa, i) => {
        pa.x += pa.vx; pa.y += pa.vy; pa.life -= 0.02;
        if (pa.life <= 0) particles.splice(i, 1);
    });
}

function updateHP() {
    document.getElementById('hp-text').innerText = player.hp;
    if (player.hp <= 0) {
        gameActive = false;
        alert("NAVE DESTRUÍDA! Score: " + score);
        location.reload();
    }
}

function showVictory() {
    playSound('victory');
    document.getElementById('final-score').innerText = score;
    document.getElementById('victory-screen').style.display = 'flex';
}

function draw() {
    ctx.fillStyle = '#000510';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Player
    ctx.fillStyle = '#00f2ff';
    ctx.fillRect(player.x, player.y, player.w, player.h);

    // Boss
    if (bossMode) {
        ctx.fillStyle = '#ff0044';
        ctx.fillRect(boss.x, boss.y, boss.w, boss.h);
        // Detalhes do Boss
        ctx.fillStyle = '#fff';
        ctx.fillRect(boss.x + 20, boss.y + 20, 30, 30);
        ctx.fillRect(boss.x + boss.w - 50, boss.y + 20, 30, 30);
    }

    // Desenhar Tiros
    ctx.fillStyle = '#ff0'; projectiles.forEach(p => ctx.fillRect(p.x, p.y, p.w, p.h));
    ctx.fillStyle = '#f00'; bossProjectiles.forEach(bp => ctx.fillRect(bp.x, bp.y, bp.w, bp.h));

    // Inimigos
    ctx.fillStyle = '#888'; enemies.forEach(en => ctx.fillRect(en.x, en.y, en.w, en.h));

    // Partículas
    particles.forEach(pa => {
        ctx.globalAlpha = pa.life;
        ctx.fillStyle = pa.color;
        ctx.fillRect(pa.x, pa.y, 4, 4);
    });
    ctx.globalAlpha = 1.0;

    update();
    requestAnimationFrame(draw);
}

draw();
</script>
</body>
</html>